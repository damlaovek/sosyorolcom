{% load index %}
{% load static %}
<script src="{% static 'js/newpost.js' %}"></script>
<div class="full-width align-center mt10">
    <form>
    <div class="bsbb box p20 title fs19 cp-container" id="cp-container">
        {{create_post_dict.createpoll}}
        <div class="absolute inline-flex" style="right:20px;top:1px;">
            <div class="btn p010 hand m10" style="border-radius:4px;line-height: 30px; height:30px;" onclick="document.getElementById('drafts-popup').classList.toggle('hidden');">
                <p  class="fs15 noselect" id='drafts'>{{newpost_actions_dict.drafts}}&nbsp;({{drafts|length}})</p>
            </div>
            <div class="btn inline-block p010 m100 hand" style="border-radius:4px;min-width:150px;height: 30px;line-height: 30px;" id='poll-duration-btn' onclick="showHide('poll-duration-menu')">
                <p  class="fs15 left noselect" id='poll-duration'>{{create_post_dict.pollduration}}</p>
                <svg class="right" width="10px" height="10px" viewBox="0 0 10 10" style="margin:10px 0;">
                    <g>
                        <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 9.628906 2.285156 L 0.488281 2.285156 C 0.0546875 2.285156 -0.164062 2.808594 0.144531 3.117188 L 4.714844 7.6875 C 4.902344 7.875 5.214844 7.875 5.402344 7.6875 L 9.96875 3.117188 C 10.28125 2.808594 10.0625 2.285156 9.628906 2.285156 Z M 9.628906 2.285156 "/>
                    </g>
                </svg>
            </div>
        </div>
        <ul  id="poll-duration-menu" class="full-shadow-border box dropdown hidden fs15" style='right:20px; top: 55px;'>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '{{create_post_dict.unlimitedtime}}');validateForm();">{{create_post_dict.unlimitedtime}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '1 {{create_post_dict.day}}');validateForm();">1 {{create_post_dict.day}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '2 {{create_post_dict.days}}');validateForm();">2 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '3 {{create_post_dict.days}}');validateForm();">3 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '4 {{create_post_dict.days}}');validateForm();">4 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="fs15 lh20 text hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '5 {{create_post_dict.days}}');validateForm();">5 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="lh20 text fs15 hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '6 {{create_post_dict.days}}');validateForm();">6 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
            <li style="font-size: 15px;" class="lh20 text fs15 hand p10 noselect poll-duration-menu-item" onclick="selectPollDuration(this, '7 {{create_post_dict.days}}');validateForm();">7 {{create_post_dict.days}}
                <div class="tick">
                    <svg width="14px" height="14px" viewBox="0 0 14 14">
                        <g>
                            <path style=" stroke:none;fill-rule:nonzero;fill:var(--main-color);fill-opacity:1;" d="M 13.796875 2.0625 C 13.523438 1.789062 13.078125 1.789062 12.804688 2.0625 L 4.417969 10.449219 L 1.195312 7.226562 C 0.921875 6.953125 0.476562 6.953125 0.203125 7.226562 C -0.0664062 7.5 -0.0664062 7.945312 0.203125 8.21875 L 3.921875 11.9375 C 4.195312 12.210938 4.640625 12.207031 4.914062 11.9375 L 13.796875 3.054688 C 14.070312 2.78125 14.066406 2.335938 13.796875 2.0625 Z M 13.796875 2.0625 "/>
                        </g>
                    </svg>
                </div>
            </li>
        </ul>
    </div>
    <div class="bsbb box p20 title fs18 cp-container" style="margin:10px auto;">
        <div class="full-width">
            <textarea name="cp-title" style='padding-right:70px;' rows="1" onblur='this.classList.remove("active");document.getElementById("title-counter").innerHTML = "";' onfocus='this.classList.add("active");var len = this.value.length;document.getElementById("title-counter").innerHTML = len+"/"+250;' onkeyup="updateTextareaCounter(this, 'title-counter', 250);validateForm();" class="bsbb box full-width p10 lh20 fs15 text textarea" maxlength="250" placeholder="{{newpost_actions_dict.title}}"></textarea>
            <p class='noselect fs13 absolute cg2' style="bottom:0;right:10px;line-height:40px;" id='title-counter'></p>
        </div>
        <div class="bsbb full-width box mt10">
            {% include 'posts/createpost/rich_text_editor.html' %}
        </div>
        <ul class="connected-sortable droppable-area full-width mt10" id='poll-options-list'>
            <li class="full-width inline-flex hand mt10" id='poll-option-1'>
                <p style="line-height:12px;margin:14px 0;" class="cg2 hand">=</p>
                <div class='m010' style='width:calc(100% - 80px)'>
                    <textarea style='padding-right:70px;' placeholder="{{create_post_dict.option}}" rows="1" onblur='this.classList.remove("active");document.getElementById("poll-option-1-counter").innerHTML = "";' onfocus='this.classList.add("active");var len = this.value.length;document.getElementById("poll-option-1-counter").innerHTML = len+"/"+120;' onkeyup="updateTextareaCounter(this, 'poll-option-1-counter', 120);validateForm();" class="bsbb full-width box p10 lh20 fs15 text textarea" maxlength="120"></textarea>
                    <p class='noselect fs13 absolute cg2' style="bottom:0;right:10px;line-height:40px;" id='poll-option-1-counter'></p>
                </div>
                <p class="sqrt30 border rounded hand cg2 poll-option-btn" style='line-height:30px; text-align:center;font-size:18px;margin:5px 0;margin-right:10px;' onclick="addPollOption('poll-option-1','{{create_post_dict.option}}', '{{create_post_dict.addrule}}', '{{create_post_dict.removerule}}');">+</p>
                <p class="sqrt30 border rounded hand cg2 poll-option-btn" style='line-height:30px; text-align:center;font-size:20px;margin:5px 0;' onclick="removePollOption('poll-option-1', '{{create_post_dict.removerule}}');">-</p>
            </li>
            <li class="full-width inline-flex hand mt10" id='poll-option-2'>
                <p style="line-height:12px;margin:14px 0;" class="cg2 hand">=</p>
                <div class='m010' style='width:calc(100% - 80px)'>
                    <textarea style='padding-right:70px;' placeholder="{{create_post_dict.option}}" rows="1" onblur='this.classList.remove("active");document.getElementById("poll-option-2-counter").innerHTML = "";' onfocus='this.classList.add("active");var len = this.value.length;document.getElementById("poll-option-2-counter").innerHTML = len+"/"+120;' onkeyup="updateTextareaCounter(this, 'poll-option-2-counter', 120);validateForm();" class="bsbb full-width box p10 lh20 fs15 text textarea" maxlength="120"></textarea>
                    <p class='noselect fs13 absolute cg2' style="bottom:0;right:10px;line-height:40px;" id='poll-option-2-counter'></p>
                </div>
                <p class="sqrt30 border rounded hand cg2 poll-option-btn" style='line-height:30px; text-align:center;font-size:18px;margin:5px 0;margin-right:10px;' onclick="addPollOption('poll-option-2','{{create_post_dict.option}}', '{{create_post_dict.addrule}}', '{{create_post_dict.removerule}}');">+</p>
                <p class="sqrt30 border rounded hand cg2 poll-option-btn" style='line-height:30px; text-align:center;font-size:20px;margin:5px 0;' onclick="removePollOption('poll-option-2', '{{create_post_dict.removerule}}');">-</p>
            </li>
        </ul>
    </div>
    <div class="bsbb box p020 title cp-container">
        <div class="p100 full-width inline-flex" id="flair_container">
            <div class="nocommunity textarea p10 fs15 cg2 hand box flair" data-title="{{newpost_actions_dict.spoiler}}" id="flair" onclick="this.classList.toggle('active');" style="border-radius:18px;">&nbsp;&nbsp;Spoiler&nbsp;&nbsp;</div>
            <div class="nocommunity textarea p10 fs15 cg2 ml10 hand box flair" data-title="{{newpost_actions_dict.nsfw}}" id="flair"  onclick="this.classList.toggle('active');" style="border-radius:18px;">&nbsp;&nbsp;NSFW&nbsp;&nbsp;</div>
        </div>
    </div>
    <div class="cp-container" style="margin:10px auto;">
        <p class="fwbold cg2 mt20 mb10">{{word_list|getword:"where-to-publish"|ucwords}}</p>
        <div class="bsbb box p20 title">
            <div class="full-width" id="selected-communities">
                <ul class="inline-block full-width">
                    <li class="inline-flex btn left p010 selected-community noselect" style="height:30px;border-radius: 20px;opacity:1;">
                        <img src="{{current_user.avatar_url}}" class="rounded sqr20" style="margin:5px 0;"/>
                        <p class="lh20 fs15 noselect" style="margin:5px 10px;">u/{{current_user.user_login}}</p>
                    </li>
                </ul>
            </div>
            <textarea rows="1" onblur='this.classList.remove("active");' onfocus='this.classList.add("active");' class="bsbb box full-width p10 lh20 fs15 text oh" style="resize:none;height:40px;overflow:hidden;" placeholder="{{newpost_actions_dict.searchcommunity}}" id="communitysearch"></textarea>
            <div class="full-width dropdown hidden" style="width:calc(100% - 40px); max-height:110px; overflow:scroll;" id="communities">
            </div>
        </div>
    </div>
    <div class="bsbb box p20 title fs18 cp-container">
        <div class="full-width inline-block">
            <div class="bsbb p10 hand left fs15 lh20 text noselect textarea" onmouseover='this.style.opacity = 0.75;' onmouseout='this.style.opacity = 1.0;' style="width:calc(25% - 15px); text-align:center;border-radius:4px;">{{newpost_actions_dict.cancel}}</div>
            <div class="bsbb p10 m020 hand left fs15 lh20 text noselect textarea" onmouseover='this.style.opacity = 0.75;' onmouseout='this.style.opacity = 1.0;'  style="width:calc(25% - 15px); text-align:center;border-radius:4px;">{{newpost_actions_dict.clear}}</div>
            <div class="bsbb p10 hand left fs15 lh20 text noselect textarea" onmouseover='this.style.opacity = 0.75;' onmouseout='this.style.opacity = 1.0;'  style="width:calc(25% - 15px);margin-right:20px; text-align:center;border-radius:4px;">{{newpost_actions_dict.save}}</div>
            <input disabled type="submit" id="cp-sendBtn" class="btn p10 left fs15 lh20 noselect" style="border-radius:4px;height:30px;width:calc(25% - 35px); border:none; text-align:center; color:var(--main-color); font-weight:700;" value="{{newpost_actions_dict.send}}" onclick="return savePoll()"/>
        </div>
    </div>
    </form>
</div>
<script>
    const commSearchBar = document.querySelector("#communitysearch");
    const commSearchResultsContainer = document.querySelector("#communities");
    const selectedCommsContainer = document.querySelector("#selected-communities");
    const flairContainer = document.querySelector("#flair_container");

    commSearchBar.addEventListener("keyup", function(e) {
        if (e.target.value.trim().length > 0){
            getSearchResults(e.target.value);
        }else{
            commSearchResultsContainer.innerHTML = "";
            commSearchResultsContainer.classList.add("hidden");
        }
    });
    const getSearchResults = searchTerm => {
        searchTerm = searchTerm.toLowerCase();
        selectedComms = "";
        var communities = document.getElementsByClassName("selected-community");        
        for(var i = 1; i<communities.length; i++){
            if(i == 1){
                selectedComms = selectedComms + communities[i].getElementsByTagName("p")[0].innerText.split("/")[1];
            }else{
                selectedComms = selectedComms + ", " + communities[i].getElementsByTagName("p")[0].innerText.split("/")[1];
            }
        }
        j.ajax({
            type: "POST",
            url: "/pickpostcommunities",
            data: {search: searchTerm, selectedComms: selectedComms},
            success: function(response) {
                commSearchResultsContainer.innerHTML = response;
                if(commSearchResultsContainer.classList.contains("hidden")){
                    commSearchResultsContainer.classList.remove("hidden");
                }
            }
        });
    };
    function addSelectedCommunity(elem){
        commSearchBar.value = "";
        commSearchResultsContainer.innerHTML = "";
        commSearchResultsContainer.classList.add("hidden");
        selectedCommsList = selectedCommsContainer.getElementsByTagName("ul")[0];
        if(selectedCommsContainer.classList.contains("dnone")){
            selectedCommsContainer.classList.remove("dnone");
        }
        var liId = selectedCommsList.length + 1;
        var imgUrl = elem.getElementsByTagName('img')[0].src;
        var bc = elem.getElementsByTagName('img')[0].style.backgroundColor;
        var commName = elem.getElementsByTagName('p')[0].innerHTML;
        var li = document.createElement('li');
        li.setAttribute("class","inline-flex btn left p010 selected-community noselect");
        li.setAttribute("id","selected-community-"+liId);
        li.style.height = "30px";
        li.style.borderRadius = "20px";
        li.style.opacity = "1";
        var img = document.createElement('img');
        img.style.backgroundColor = bc;
        img.src = imgUrl;
        img.setAttribute("class","rounded sqr20");
        img.style.margin = "5px 0";
        var p = document.createElement('p');
        p.innerHTML = commName;
        p.setAttribute("class","lh20 fs15 noselect");
        p.style.margin = "5px 10px";
        var x = document.createElement('p');
        x.setAttribute("class","fs13 lh20 hand");
        x.style.margin = "6px 0";
        x.innerHTML = "&#x2715";
        x.setAttribute("onclick","removeSelectedCommunity("+liId+")");
        li.appendChild(img);
        li.appendChild(p);
        li.appendChild(x);
        selectedCommsList.appendChild(li);
        j.ajax({
            type: "POST",
            url: "/getcommunityflairs",
            data: {community: commName.replace("c/", "")},
            success: function(response) {
                flairContainer.innerHTML += response;
            }
        });
    }
    function removeSelectedCommunity(liId){
        var commname = document.getElementById('selected-community-'+liId).getElementsByTagName('p')[0].innerHTML.replace("c/", "");
        var flairs = document.getElementsByClassName(commname);
        for(var i=0; i<flairs.length; i++){
            flairs[i].remove();
        }
        document.getElementById('selected-community-'+liId).remove();
        selectedCommsList = selectedCommsContainer.getElementsByTagName("ul")[0];
        if(selectedCommsList.getElementsByTagName("li").length == 0){
            selectedCommsContainer.classList.add("dnone");
        }
    }
    function toggleFlair(elem, bc, tc){
        if(elem.classList.contains("active")){
            elem.style.backgroundColor = "var(--white)";
            elem.style.color = "var(--gray2)";
        }else{
            elem.style.backgroundColor = bc;
            elem.style.color = tc;
        }
        elem.classList.toggle("active");
    }
    j(document).mouseup(function(e) 
    {
        var container = j("#communities");

        // if the target of the click isn't the container nor a descendant of the container
        if (!container.is(e.target) && container.has(e.target).length === 0) 
        {
            commSearchResultsContainer.classList.add("hidden");
        }
    });

    function validateForm(){
        var quizTitle = document.getElementsByName("cp-title")[0].value;
        if(quizTitle.length == 0){
            document.getElementById('cp-sendBtn').classList.remove('active');
            document.getElementById("cp-sendBtn").disabled = true;
            return false;
        }
        if( document.getElementById("poll-duration").innerText == "{{create_post_dict.pollduration}}"){
            document.getElementById('cp-sendBtn').classList.remove('active');
            document.getElementById("cp-sendBtn").disabled = true;
            return false;
        }
        var options = document.getElementById("poll-options-list").getElementsByTagName("li");
        for(var i=0; i<options.length; i++){
            var optionText = options[i].getElementsByTagName("div")[0].getElementsByTagName("textarea")[0].value;
            if(optionText.length == 0){
                document.getElementById('cp-sendBtn').classList.remove('active');
                document.getElementById("cp-sendBtn").disabled = true;
                return false;
            }
        }
        document.getElementById('cp-sendBtn').classList.add('active');
        document.getElementById("cp-sendBtn").disabled = false;
        return true;   
    }
    
    function savePoll(){
        var title = document.getElementsByName("cp-title")[0].value;
        var content = document.getElementById("editor").innerHTML;
        if(content.length == 0){
            content = "";
        }
        var flairDict = {};
        var flairCounter = 1;
        var flairs = document.getElementsByClassName("flair");
        for(var i = 0; i<flairs.length; i++){
            if(flairs[i].classList.contains("active")){
                flairDict[flairCounter] = flairs[i].getElementsByTagName("p")[0].innerHTML.replace("&nspb;","").replace("\xa0","")+"--"+flairs[i].classList[0];
                flairCounter++;
            }
        }
        var publishCounter = 1;
        var placesToPublish = {};
        var communities = document.getElementsByClassName("selected-community");        
        for(var i = 1; i<communities.length; i++){
            placesToPublish[publishCounter] = communities[i].getElementsByTagName("p")[0].innerText.split("/")[1];
            publishCounter++;
        }
        var optionsCounter = 1;
        var optionsDict = {}
        var options = document.getElementById("poll-options-list").getElementsByTagName("li");
        for(var i = 0; i<options.length; i++){
            optionsDict[optionsCounter] = options[i].getElementsByTagName("div")[0].getElementsByTagName("textarea")[0].value;
            optionsCounter++;
        }
        var data = {}
        data = {
            "post_title": title,
            "post_content": content,
            "poll_duration": document.getElementById("poll-duration").innerText,
            "poll_options": JSON.stringify(optionsDict),
            "flairs": JSON.stringify(flairDict),
            "communities": JSON.stringify(placesToPublish),
        }
        jQuery.ajax({
            type: "POST",
            url:"{% url 'savenewpoll' %}",
            data: data,
            success: function(response) {
                displayAlert(response.content);
            }
        });
        return false;
    }
</script>