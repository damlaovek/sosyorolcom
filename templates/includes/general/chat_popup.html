{% load index %}
{% load static %}
<div class="bsbb bcgrayish full-shadow-border fixed alignbr br4 noselect hand" id="chat_popup" style="width:314px;right:27px;z-index:99999999;" onclick="openCloseChatPopupList(event)">
    <div class="bsbb full-width p10 inline-block" style="padding-bottom:5px;" id="chat_popup_inner">
        <div class="sqrt30 left">
            <img class="non-draggable rounded sqrt30" src="{{current_user.avatar_url}}"/>
            <div class="noselect absolute sqr10 bcb rounded" style="right:-7px; bottom:0;border:2px solid var(--grayish);"></div>
        </div>
        <p class="fwbold m010 left lh30">{{word_list|getword:"chat"|ucfirst}}</p>
        <i class="icon fas fa-angle-up right hand lh30 fs19 cg2 tac" style="margin-top:-5px;width:20px;" id="chat_popup_list_arrow"></i>
        <svg width='20px' height='20px' viewBox='0 0 20 20' class="right icon hand rotate90 hand" style="margin-top:-5px;" id="chat_popup_dots" onclick="return false;">
            <g>
                <path style="fill:none;stroke:var(--gray2);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1;stroke-miterlimit:4;" d="M 12.998437 12 C 12.998437 12.553125 12.553125 12.998437 12 12.998437 C 11.446875 12.998437 11.001563 12.553125 11.001563 12 C 11.001563 11.446875 11.446875 11.001563 12 11.001563 C 12.553125 11.001563 12.998437 11.446875 12.998437 12 Z M 12.998437 12" transform="matrix(0.833333,0,0,0.833333,0,0)"/>
                <path style="fill:none;stroke:var(--gray2);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1;stroke-miterlimit:4;" d="M 12.998437 5.001562 C 12.998437 5.55 12.553125 6 12 6 C 11.446875 6 11.001563 5.55 11.001563 5.001562 C 11.001563 4.448437 11.446875 3.998437 12 3.998437 C 12.553125 3.998437 12.998437 4.448437 12.998437 5.001562 Z M 12.998437 5.001562" transform="matrix(0.833333,0,0,0.833333,0,0)"/>
                <path style="fill:none;stroke:var(--gray2);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-opacity:1;stroke-miterlimit:4;" d="M 12.998437 18.998437 C 12.998437 19.551562 12.553125 20.001562 12 20.001562 C 11.446875 20.001562 11.001563 19.551562 11.001563 18.998437 C 11.001563 18.45 11.446875 18 12 18 C 12.553125 18 12.998437 18.45 12.998437 18.998437 Z M 12.998437 18.998437" transform="matrix(0.833333,0,0,0.833333,0,0)"/>
            </g>
        </svg>
        <div class="icon right hand openChatBoxPopupBtn" style="margin-top:-5px;" id="openChatBoxPopupBtn" onclick="openCloseChatBoxPopup('open')">
            <svg width='20px' height='20px' viewBox='0 0 20 20' style="margin-top:2.5px; margin-left:4px;" class="openChatBoxPopupBtn">
                <g class="openChatBoxPopupBtn">
                    <path class="openChatBoxPopupBtn" style='stroke:var(--gray2);stroke-width:1;fill-rule:nonzero;fill:var(--gray2);fill-opacity:1;' d='M 10.742188 7.992188 L 10.242188 7.992188 C 10.167969 7.992188 10.109375 8.015625 10.0625 8.0625 C 10.015625 8.109375 9.992188 8.171875 9.992188 8.242188 L 9.992188 10.742188 C 9.992188 11.085938 9.871094 11.378906 9.625 11.625 C 9.382812 11.867188 9.085938 11.992188 8.742188 11.992188 L 2.25 11.992188 C 1.90625 11.992188 1.609375 11.867188 1.367188 11.625 C 1.121094 11.378906 1 11.085938 1 10.742188 L 1 4.246094 C 1 3.902344 1.121094 3.609375 1.367188 3.363281 C 1.609375 3.121094 1.90625 2.996094 2.25 2.996094 L 7.746094 2.996094 C 7.816406 2.996094 7.878906 2.972656 7.925781 2.925781 C 7.96875 2.878906 7.992188 2.820312 7.992188 2.746094 L 7.992188 2.25 C 7.992188 2.175781 7.96875 2.117188 7.925781 2.070312 C 7.878906 2.023438 7.816406 2 7.746094 2 L 2.25 2 C 1.628906 2 1.097656 2.21875 0.660156 2.660156 C 0.21875 3.097656 0 3.628906 0 4.246094 L 0 10.742188 C 0 11.363281 0.21875 11.890625 0.660156 12.332031 C 1.097656 12.769531 1.628906 12.992188 2.25 12.992188 L 8.742188 12.992188 C 9.363281 12.992188 9.890625 12.769531 10.332031 12.332031 C 10.773438 11.890625 10.992188 11.363281 10.992188 10.742188 L 10.992188 8.242188 C 10.992188 8.171875 10.96875 8.109375 10.921875 8.0625 C 10.875 8.015625 10.816406 7.992188 10.742188 7.992188 Z M 10.742188 7.992188 '/>
                    <path class="openChatBoxPopupBtn" style='stroke:none;fill-rule:nonzero;fill:var(--gray2);fill-opacity:1;' d='M 13.839844 1.148438 C 13.742188 1.046875 13.625 1 13.488281 1 L 9.492188 1 C 9.359375 1 9.242188 1.046875 9.140625 1.148438 C 9.042969 1.246094 8.992188 1.363281 8.992188 1.5 C 8.992188 1.632812 9.042969 1.75 9.140625 1.851562 L 10.515625 3.222656 L 5.425781 8.3125 C 5.375 8.367188 5.347656 8.425781 5.347656 8.492188 C 5.347656 8.5625 5.375 8.621094 5.425781 8.671875 L 6.316406 9.5625 C 6.367188 9.617188 6.425781 9.640625 6.496094 9.640625 C 6.5625 9.640625 6.621094 9.617188 6.675781 9.5625 L 11.765625 4.472656 L 13.140625 5.847656 C 13.238281 5.945312 13.355469 5.996094 13.488281 5.996094 C 13.625 5.996094 13.742188 5.945312 13.839844 5.847656 C 13.941406 5.75 13.988281 5.632812 13.988281 5.496094 L 13.988281 1.5 C 13.988281 1.363281 13.941406 1.246094 13.839844 1.148438 Z M 13.839844 1.148438 '/>
                </g>
            </svg>
        </div>
    </div>
    <div class="bsbb full-width dnone" id="chats_list_popup">
    </div>
</div>
<div class="bsbb fixed alignbr dnone" id="chat_box_popup_container" style="right:340px;z-index:99999999;">
    <div class="bsbb bcw full-shadow-border right br4 noselect hand dnone mr10" id="chat_box_popup" style="width:314px;">
        <div class="bsbb bcgrayish p100 full-width inline-block bb" style="padding-bottom:5px;">
            <p class="left lh30 fwbold ml10">{{word_list|getword:"new_chat"|ucwords}}</p>
            <i class="right icon fas fa-times hand lh30 fs15 cg2 tac" style="margin-top:-5px;width:20px;" onclick="openCloseChatBoxPopup('close');"></i>
        </div>
        <div class="full-width">
            <div class="bsbb full-width inline-block bb">
                <div class="left inline-block" id="selected-people-chat-popup">
                </div>
                <div class="left" style="width:260px;">
                    <input type="text" name="search_people_chat_popup" id="search_people_chat_popup" class="bsbb p10" style="background: transparent;" placeholder="{{word_list|getword:'search-for-users'|ucfirst}}">
                    <div class="absolute aligntl full-width bringfront" style="top:38px;" id="search_people_results_chat_popup">
                    </div>
                </div>
            </div>
            <div class="bsbb w20 m10 p10 bcw" style="height:200px;">
    
            </div>
            <div class="full-width bt" style="min-height:30px;">
                <textarea class="bsbb text textarea w20 m10 p10 br4" rows="1" style="max-height: 100px;overflow-y: scroll;" placeholder='{{word_list|getword:"write-a-message"|ucfirst}}' id="chatpopuptext" onkeyup="validateChatPopupForm()"></textarea>
                <div class="w20 m010 mb10 inline-block">
                    <div class="left hand" style="width:35px;height:35px; margin-top: 2.5px;">
                        <div class="icon">
                            <i class="fas fa-image cg2 fs19" style="width:20px;height:20px;"></i>
                        </div>
                        <div id="imageUploadForm" class="hand absolute icon" style="width:15px;height:15px;bottom:0;left:0;overflow:hidden;cursor:pointer;opacity:0;">
                            <input type='file' onchange="uploadImgChatPopup(this, {% url 'uploadmedia' %});" class="hand sqr15" style="overflow:hidden;opacity:0;" id="imageUpload" name="file" accept=".png, .jpg, .jpeg" />
                        </div>
                    </div>
                    <div class="left hand" style="width:35px;height:35px; margin-top: 2.5px;">
                        <i class="fas fa-smile icon cg2 fs19" id="sosmojibtn_chatpopup" onclick="openCloseSosmojisChatPopup(this);"></i>
                        <div class="absolute full-shadow-border br4 bcw dnone" style="left:0;bottom:30px;width:260px;" id="sosmojis_chat_popup">
                            <div class="bsbb full-width p10 bb">
                                <p class="title fs15 lh20">{{word_list|getword:"select-a-sosmoji"|ucfirst}}</p>
                                <svg style="position:absolute;top:7.5px;right:7.5px;cursor:pointer;padding:5px;width:15px;height:15px;z-index:9999;" class="icon hand" onclick="openCloseSosmojisChatPopup(document.getElementById('sosmojibtn_chatpopup'));" viewBox="0 0 15 15" version="1.1">
                                    <g id="surface1">
                                        <path style=" stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 0.132812 14.878906 C 0.222656 14.964844 0.335938 15.011719 0.453125 15.011719 C 0.570312 15.011719 0.683594 14.964844 0.773438 14.878906 L 7.503906 8.144531 L 14.238281 14.878906 C 14.324219 14.964844 14.441406 15.011719 14.558594 15.011719 C 14.675781 15.011719 14.789062 14.964844 14.878906 14.878906 C 15.054688 14.703125 15.054688 14.414062 14.878906 14.238281 L 8.144531 7.503906 L 14.878906 0.773438 C 15.054688 0.597656 15.054688 0.308594 14.878906 0.132812 C 14.703125 -0.0429688 14.414062 -0.0429688 14.238281 0.132812 L 7.503906 6.863281 L 0.773438 0.132812 C 0.597656 -0.0429688 0.308594 -0.0429688 0.132812 0.132812 C -0.0429688 0.308594 -0.0429688 0.597656 0.132812 0.773438 L 6.863281 7.503906 L 0.132812 14.238281 C -0.0429688 14.414062 -0.0429688 14.703125 0.132812 14.878906 Z M 0.132812 14.878906 "/>
                                    </g>
                                </svg>
                            </div>
                            <div class="bsbb p10 full-width inline-block" style="height:240px; overflow-y:scroll;">
                                {% for file in word_list|get_sosmojis %}
                                    {% if file != ".DS_Store" %}  
                                        <img src="{% static 'assets/img/sosmojis/' %}{{file}}" alt="" class="hand sqr50 p5 left sosmoji" onclick="sendSosmojiChatPopup(this);">
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <input disabled type="submit" id="send_chat_popup" class="btn p10 right fs15 lh20 noselect cb tac br4" style="height:30px;border:none; font-weight:700;opacity:0.8;" value="{{word_list|getword:'send'|ucfirst}}" onclick="return sendChatPopup('{{current_user.ID}}');"/>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const userSearchBarChatPopup = document.querySelector("#search_people_chat_popup");
    const userSearchResultsContainerChatPopup = document.querySelector("#search_people_results_chat_popup");
    const selectedUsersContainerChatPopup = document.querySelector("#selected-people-chat-popup");
    userSearchBarChatPopup.addEventListener("keyup", function(e) {
        if (e.target.value.trim().length > 0){
            getUserSearchResultsChatPopup(e.target.value);
        }else{
            userSearchResultsContainerChatPopup.innerHTML = "";
            userSearchResultsContainerChatPopup.classList.add("dnone");
        }
    });
    const getUserSearchResultsChatPopup = searchTerm => {
        searchTerm = searchTerm.toLowerCase();
        selectedUsers = "";
        var users = document.getElementById("selected-people-chat-popup").getElementsByTagName("div");
        if(users.length > 0){
            for(var i = 0; i<users.length; i++){
                if(i == 0){
                    selectedUsers = selectedUsers + users[i].id.split("_")[1];
                }else{
                    selectedUsers = selectedUsers + ", " + users[i].id.split("_")[1];
                }
            }
        }
        j.ajax({
            type: "POST",
            url: "/get_searched_people",
            data: {search: searchTerm, selectedUsers: selectedUsers },
            success: function(response) {
                userSearchResultsContainerChatPopup.innerHTML = response;
                var items = userSearchResultsContainerChatPopup.getElementsByClassName("userlist_item");
                for(var i=0; i<items.length; i++){
                    items[i].onclick = function(){selectUserChatPopup(this)};
                }
                if(userSearchResultsContainerChatPopup.classList.contains("dnone")){
                    userSearchResultsContainerChatPopup.classList.remove("dnone");
                }
            }
        });
    };
    var j = jQuery.noConflict();
    j(document).ready(function()
    {
        refreshChatsListPopup();
        j(document).mouseup(function(e) 
        {
            var container = j("#search_people_results_chat_popup");
            // if the target of the click isn't the container nor a descendant of the container
            if (!container.is(e.target) && container.has(e.target).length === 0) 
            {
                document.getElementById("search_people_results_chat_popup").classList.add("dnone");
            }
        });
    });
    function selectUserChatPopup(elem){
        document.getElementById("search_people_chat_popup").value = "";
        var container = document.getElementById('selected-people-chat-popup');
        var newelem = document.createElement("div");
        newelem.setAttribute("class", "left p510 mt5 br13 bcb cw fwbold ml10");
        newelem.id = elem.id;
        newelem.innerText = elem.innerText;
        var closeBtn = document.createElement("span");
        closeBtn.setAttribute("class", "ml10 hand noselect");
        closeBtn.innerHTML = "&#10005;";
        closeBtn.onclick = function(){newelem.remove();}
        newelem.appendChild(closeBtn);
        container.appendChild(newelem);
        document.getElementById("search_people_results_chat_popup").getElementsByTagName("ul")[0].removeChild(elem);
        if(document.getElementById("search_people_results_chat_popup").getElementsByTagName("ul")[0].getElementsByTagName("li").length == 0){
            document.getElementById("search_people_results_chat_popup").classList.add("dnone");
        }
        validateChatPopupForm();
        userSearchBarChatPopup.value = "";
        userSearchResultsContainerChatPopup.innerHTML = "";
        userSearchResultsContainerChatPopup.classList.add("dnone");
        j("#search_people_chat_popup").trigger("focusout");
    }
    function refreshChatsListPopup(){
        var chatRef = firebase.database().ref('users/{{current_user.ID}}/chats');
        chatRef.on('value', (snapshot) => {
            console.log("user chats on value");
            var index = 1;
            var objects = {};
            snapshot.forEach((childSnapshot) => {
                var childKey = childSnapshot.key;
                var childData = childSnapshot.val();
                firebase.database().ref('chats/'+childKey).on('value', (snapshot3) => {
                    console.log("a chat on value");
                    var childData3 = snapshot3.val();
                    firebase.database().ref('chats/'+childKey+'/messages').limitToLast(1).on('value', (snapshot2) => {
                        console.log("a chat messages on value");
                        snapshot2.forEach((childSnapshot2) => {
                            var childData2 = childSnapshot2.val();
                            var chRef = firebase.database().ref("chats");
                            var singleObj = {};
                            singleObj['ID'] = childData3.ID;
                            singleObj['receivers'] = childData3.users;
                            singleObj['msg'] = childData2.msg;
                            singleObj['datetime'] = childData2.datetime;
                            singleObj['seen'] = childData.seen;
                            singleObj['sender'] = childData2.sender;
                            var found = false;
                            for (var key in objects){
                                if(objects[key]["ID"] == childData3.ID){
                                    found = true;
                                    objects[key] = singleObj;
                                }
                            }
                            if(!found){
                                objects[index] = singleObj;
                            }
                            if(index == snapshot.numChildren()){
                                console.log(index);
                                j.ajax({
                                    type: "POST",
                                    url: "/get_chat_popup_item",
                                    data: {chats: JSON.stringify(objects)},
                                    success: function(response) {
                                        document.getElementById('chats_list_popup').innerHTML = response;
                                    }
                                });
                            }else{
                                console.log(index);
                                index += 1;
                            }
                        });
                    });
                });
            });
        });
    }
    function validateChatPopupForm( msg2send=""){
        var chattext = document.getElementById("chatpopuptext").value;
        var sendbtn = document.getElementById("send_chat_popup");
        var users = document.getElementById("selected-people-chat-popup").getElementsByTagName("div");
        if(chattext == "" && msg2send == ""){
            sendbtn.disabled = true;
            sendbtn.style.opacity = "0.8";
            sendbtn.style.cursor = "default";
            return false;
        }else if(users.length == 0){
            sendbtn.disabled = true;
            sendbtn.style.opacity = "0.8";
            sendbtn.style.cursor = "default";
            return false;
        }else{
            sendbtn.disabled = false;
            sendbtn.style.opacity = "1";
            sendbtn.style.cursor = "pointer";
            return true;
        }
    }
    function validateChatPopupBoxForm(chatId, msg2send=""){
        var chattext = document.getElementById("chatpopuptext_"+chatId).value;
        var sendbtn = document.getElementById("send_chat_popup_"+chatId);
        var users = document.getElementById("receiver_"+chatId).innerText.split("/")[1];
        if(chattext == "" && msg2send == ""){
            sendbtn.disabled = true;
            sendbtn.style.opacity = "0.8";
            sendbtn.style.cursor = "default";
            return false;
        }else if(users == ""){
            sendbtn.disabled = true;
            sendbtn.style.opacity = "0.8";
            sendbtn.style.cursor = "default";
            return false;
        }else{
            sendbtn.disabled = false;
            sendbtn.style.opacity = "1";
            sendbtn.style.cursor = "pointer";
            return true;
        }
    }
    function sendChatPopup(cuid, msg2send=""){
        if(validateChatPopupForm(msg2send)){
            selectedUsers = "";
            var users = document.getElementById("selected-people-chat-popup").getElementsByTagName("div");
            var msg = document.getElementById('chatpopuptext').value;
            if(msg2send != ""){
                msg = msg2send;
            }
            var currentdate = new Date(); 
            var datetime =  currentdate.getDate() + "/"
                            + (currentdate.getMonth()+1)  + "/" 
                            + currentdate.getFullYear() + " "  
                            + currentdate.getHours() + ":"  
                            + currentdate.getMinutes() + ":" 
                            + currentdate.getSeconds();
            var selected_users = [];
            for(var i = 0; i<users.length; i++){
                selected_users.push(parseInt(users[i].id.split("_")[1]));
            }
            selected_users.push(parseInt("{{current_user.ID}}"));
            console.log(selected_users);
            selected_users.sort(function(a, b) {
                return a - b;
            });
            console.log(selected_users);
            selectedUsers = selected_users.join(', ');
            firebase.database().ref("chats").orderByChild("users").equalTo(selectedUsers).once("value",snapshot => {
                if (snapshot.exists()){
                    var chatData = snapshot.val();
                    var msgListRef = firebase.database().ref('chats').child(Object.keys(chatData)[0]).child("messages");
                    var newMsgRef = msgListRef.push();
                    newMsgRef.set({
                        ID: newMsgRef.key,
                        sender: "{{current_user.ID}}",
                        datetime: datetime,
                        dbdate: firebase.database.ServerValue.TIMESTAMP,
                        msg: msg,
                    });
                    for(var u=0; u<selected_users.length; u++){
                        if(selected_users[u] == "{{current_user.ID}}"){
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+Object.keys(chatData)[0]).set({ID: Object.keys(chatData)[0], seen:1});
                        }else{
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+Object.keys(chatData)[0]).set({ID: Object.keys(chatData)[0], seen:0});
                        }
                    }
                    document.getElementById("selected-people-chat-popup").innerHTML = "";
                    document.getElementById('chatpopuptext').value = "";
                    openCloseChatBoxPopup("close");
                    openChatItemPopup(Object.keys(chatData)[0]);
                }else{
                    var chatListRef = firebase.database().ref('chats');
                    var newChatRef = chatListRef.push();
                    newChatRef.set({
                        ID: newChatRef.key,
                        users: selectedUsers,
                    });
                    var msgListRef = firebase.database().ref('chats').child(newChatRef.key).child("messages");
                    var newMsgRef = msgListRef.push();
                    newMsgRef.set({
                        ID: newMsgRef.key,
                        sender: "{{current_user.ID}}",
                        datetime: datetime,
                        dbdate: firebase.database.ServerValue.TIMESTAMP,
                        msg: msg,
                    });
                    for(var u=0; u<selected_users.length; u++){
                        if(selected_users[u] == "{{current_user.ID}}"){
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+newChatRef.key).set({ID: Object.keys(chatData)[0], seen:1});
                        }else{
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+newChatRef.key).set({ID: Object.keys(chatData)[0], seen:0});
                        }
                        var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+newChatRef.key).set({ID: newChatRef.key, seen:0});
                    }
                    document.getElementById("selected-people-chat-popup").innerHTML = "";
                    document.getElementById('chatpopuptext').value = "";
                    openCloseChatBoxPopup("close");
                    openChatItemPopup(newChatRef.key);
                }
            });
        }
        return false;
    }
    function sendChatPopupBox(cuid, chatId, msg2send=""){
        if(validateChatPopupBoxForm(chatId, msg2send=msg2send)){
            selectedUsers = "";
            var msg = document.getElementById('chatpopuptext_'+chatId).value;
            if(msg2send != ""){
                msg = msg2send;
            }
            var currentdate = new Date(); 
            var datetime =  currentdate.getDate() + "/"
                            + (currentdate.getMonth()+1)  + "/" 
                            + currentdate.getFullYear() + " "  
                            + currentdate.getHours() + ":"  
                            + currentdate.getMinutes() + ":" 
                            + currentdate.getSeconds();
            firebase.database().ref("chats/"+chatId).once("value",snapshot => {
                if (snapshot.exists()){
                    var chatData = snapshot.val();
                    var msgListRef = firebase.database().ref('chats').child(chatId).child("messages");
                    var newMsgRef = msgListRef.push();
                    newMsgRef.set({
                        ID: newMsgRef.key,
                        sender: "{{current_user.ID}}",
                        datetime: datetime,
                        dbdate: firebase.database.ServerValue.TIMESTAMP,
                        msg: msg,
                    });
                    var selected_users = chatData.users.split(",");
                    for(var u=0; u<selected_users.length; u++){
                        if(selected_users[u] == "{{current_user.ID}}"){
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+chatId).set({ID: Object.keys(chatData)[0], seen:1});
                        }else{
                            var userChatRef = firebase.database().ref("users/"+selected_users[u]+"/chats/"+chatId).set({ID: Object.keys(chatData)[0], seen:0});
                        }
                    }
                    document.getElementById('chatpopuptext_'+chatId).value = "";
                    firebase.database().ref('chats/'+chatId).once('value', (snapshot) => {
                        var chatData = snapshot.val();
                        firebase.database().ref('chats/'+chatId+'/messages').once('value', (snapshot2) => {
                            var messages = [];
                            var index = 1;
                            snapshot2.forEach((childSnapshot2) => {
                                var childData2 = childSnapshot2.val();
                                var singleObj = {};
                                singleObj['ID'] = childData2.key;
                                singleObj['msg'] = childData2.msg;
                                singleObj['datetime'] = childData2.datetime;
                                singleObj['sender'] = childData2.sender;
                                messages.push(singleObj);
                                if(index == snapshot2.numChildren()){
                                    j.ajax({
                                        type: "POST",
                                        url: "/getchatpopupbox",
                                        data: {chat: JSON.stringify({ID: chatData.ID, users: chatData.users, messages: messages })},
                                        success: function(response) {
                                            document.getElementById("chat_box_popup"+chatId).innerHTML = response;
                                            var objDiv = document.getElementById("chat_box_popup_messages"+chatId);
                                            objDiv.scrollTop = objDiv.scrollHeight;
                                        }
                                    });
                                }
                                index += 1;
                            });
                        });
                    });
                    //displayAlert("{{word_list|getword:'message-sent'|ucfirst}}");
                    //window.location.href = "/chat/"+Object.keys(chatData)[0];
                    //refreshChatsListPopup();
                }
            });
        }
        return false;
    }
    function openCloseSosmojisChatPopup(elem){
        document.getElementById('sosmojis_chat_popup').classList.toggle('dnone');
        if(document.getElementById('sosmojis_chat_popup').classList.contains('dnone')){
            elem.classList.remove("cb");
            elem.classList.add("cg2");
        }else{
            elem.classList.add("cb");
            elem.classList.remove("cg2");
        }
    }
    function openCloseSosmojisChatPopupBox(elem, chatId){
        document.getElementById('sosmojis_chat_popup_'+chatId).classList.toggle('dnone');
        if(document.getElementById('sosmojis_chat_popup_'+chatId).classList.contains('dnone')){
            elem.classList.remove("cb");
            elem.classList.add("cg2");
        }else{
            elem.classList.add("cb");
            elem.classList.remove("cg2");
        }
    }
    function sendSosmojiChatPopup(elem){
        var users = document.getElementById("selected-people-chat-popup").getElementsByTagName("div");
        if(users.length == 0){
            displayAlert("{{word_list|getword:'sosmoji-err'|ucfirst}}");
        }else{
            var sosmoji = elem.src;
            sendChatPopup('{{current_user.ID}}','<img data-type="sosmoji" src="'+sosmoji+'" alt="" class="sqr50"/>');
            openCloseSosmojisChatPopup(document.getElementById("sosmojibtn_chatpopup"));
        }
    }
    function sendSosmojiChatPopupBox(elem, chatId){
        var sosmoji = elem.src;
        sendChatPopupBox('{{current_user.ID}}', chatId, msg2send='<img data-type="sosmoji" src="'+sosmoji+'" alt="" class="sqr50"/>');
        openCloseSosmojisChatPopup(document.getElementById("sosmojibtn_chatpopup_"+chatId), chatId);
    }
    function sendImgChatPopup(url){
        var users = document.getElementById("selected-people-chat-popup").getElementsByTagName("div");
        if(users.length == 0){
            displayAlert("{{word_list|getword:'sosmoji-err'|ucfirst}}");
        }else{
            sendChatPopup('{{current_user.ID}}','<img src="'+url+'" alt="" class="sqr50"/>');
        }
    }
    function sendImgChatPopupBox(url, chatId){
        sendChatPopupBox('{{current_user.ID}}', chatId, msg2send='<img src="'+url+'" alt="" class="sqr50"/>');
    }
    function uploadImgChatPopup(input, url){
        if (input.files && input.files[0]) {
            var fd = new FormData();
            var files = input.files[0];
            var fullPath = input.value;
            if (fullPath) {
                var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                var filename = fullPath.substring(startIndex);
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                    var tokens = filename.split(".");
                    if (tokens[0].length > 96) {
                        tokens[0] = tokens[0].substring(0,95);
                        filename = tokens[0].concat(tokens[1]);
                    }
                }
            }
            var reader = new FileReader();
            reader.readAsDataURL(input.files[0]);
            fd.append('file',files,filename);
            j.ajax({
                type: "POST",
                url: url,
                data: fd,
                processData: false, 
                contentType: false,
                success: function(response) {
                    if(response.is_valid){
                        sendImgChatPopup(response.url);
                    }
                }
            });
        }
    }
    function uploadImgChatPopupBox(input, chatId, url){
        if (input.files && input.files[0]) {
            var fd = new FormData();
            var files = input.files[0];
            var fullPath = input.value;
            if (fullPath) {
                var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                var filename = fullPath.substring(startIndex);
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                    var tokens = filename.split(".");
                    if (tokens[0].length > 96) {
                        tokens[0] = tokens[0].substring(0,95);
                        filename = tokens[0].concat(tokens[1]);
                    }
                }
            }
            var reader = new FileReader();
            reader.readAsDataURL(input.files[0]);
            fd.append('file',files,filename);
            j.ajax({
                type: "POST",
                url: url,
                data: fd,
                processData: false, 
                contentType: false,
                success: function(response) {
                    if(response.is_valid){
                        sendImgChatPopupBox(response.url, chatId);
                    }
                }
            });
        }
    }
    function openChatItemPopup(chatId){
        var elementExists = document.getElementById("chat_box_popup"+chatId);
        if(elementExists == null){
            var container = document.getElementById('chat_box_popup_container');
            firebase.database().ref('chats/'+chatId).once('value', (snapshot) => {
                var chatData = snapshot.val();
                firebase.database().ref('chats/'+chatId+'/messages').once('value', (snapshot2) => {
                    var messages = [];
                    var index = 1;
                    snapshot2.forEach((childSnapshot2) => {
                        var childData2 = childSnapshot2.val();
                        var singleObj = {};
                        singleObj['ID'] = childData2.key;
                        singleObj['msg'] = childData2.msg;
                        singleObj['datetime'] = childData2.datetime;
                        singleObj['sender'] = childData2.sender;
                        messages.push(singleObj);
                        if(index == snapshot2.numChildren()){
                            j.ajax({
                                type: "POST",
                                url: "/getchatpopupbox",
                                data: {chat: JSON.stringify({ID: chatData.ID, users: chatData.users, messages: messages })},
                                success: function(response) {
                                    var elems = document.getElementById('chat_box_popup_container').getElementsByClassName("chat_box_item_popup");
                                    if(elems.length == 3){
                                        elems[0].remove();
                                    }
                                    document.getElementById('chat_box_popup_container').innerHTML += response;
                                    document.getElementById('chat_box_popup_container').classList.remove('dnone');
                                    var objDiv = document.getElementById("chat_box_popup_messages"+chatId);
                                    objDiv.scrollTop = objDiv.scrollHeight;
                                }
                            });
                        }
                        index += 1;
                    });
                });
            });
        }
    }

    function closeChatBoxItemPopup(chatId){
        document.getElementById("chat_box_popup"+chatId).remove();
    }

    function openCloseChatBoxPopup(op){
        if(op == "open"){
            document.getElementById('chat_box_popup_container').classList.remove('dnone');
            document.getElementById('chat_box_popup_container').classList.add('inline-block');
            document.getElementById('chat_box_popup').classList.remove('dnone');
            document.getElementById('chat_box_popup').classList.add('chat_box_popup');
        }else{
            document.getElementById('chat_box_popup').classList.add('dnone');
            var elems = document.getElementById('chat_box_popup_container').getElementsByClassName("chat_box_popup");
            if(elems.length == 0){
                document.getElementById('chat_box_popup_container').classList.remove('inline-block');
                document.getElementById('chat_box_popup_container').add("dnone");
            }
        }
    }
</script>
